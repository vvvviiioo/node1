<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∫–æ–π</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∫–æ–π</h1>
        <a href="/" class="back-button">‚¨Ö –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      </div>

      <div class="avatar-section">
        <div class="avatar-preview" id="avatarPreview">
          <div class="avatar-placeholder">
            <span>–ê–≤–∞—Ç–∞—Ä–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</span>
          </div>
        </div>

        <div class="avatar-controls">
          <div class="file-input">
            <input
              type="file"
              name="avatar"
              id="avatarInput"
              accept="image/*"
              required
            />
            <label for="avatarInput" class="file-label">
              <span class="file-button">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
              <span class="file-name" id="avatarFileName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
            </label>
          </div>

          <div class="button-group">
            <button
              onclick="uploadAvatar()"
              class="upload-button"
              id="uploadBtn"
            >
              üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É
            </button>
            <button
              onclick="deleteAvatar()"
              class="action-button delete"
              id="deleteBtn"
              disabled
            >
              üóë –£–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É
            </button>
          </div>

          <div class="info">
            <p>‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ñ–∞–π–ª—ã: JPEG, PNG, GIF, WebP</p>
            <p>üìè –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB</p>
          </div>
        </div>
      </div>

      <div class="avatar-info" id="avatarInfo">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤–∞—Ç–∞—Ä–∫–µ...</div>
      </div>

      <div class="links">
        <a href="/files" class="link-button">üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã</a>
      </div>

      <div id="message" class="message hidden"></div>
    </div>

    <script>
      let currentAvatar = null;

      async function loadAvatar() {
        try {
          const response = await fetch("/api/avatar");
          const avatar = await response.json();

          const avatarInfo = document.getElementById("avatarInfo");
          const avatarPreview = document.getElementById("avatarPreview");
          const deleteBtn = document.getElementById("deleteBtn");

          if (avatar.exists) {
            currentAvatar = avatar;

            avatarPreview.innerHTML = `
                        <img src="${avatar.url}" alt="–ê–≤–∞—Ç–∞—Ä–∫–∞" class="avatar-image">
                    `;

            avatarInfo.innerHTML = `
                        <div class="avatar-details">
                            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤–∞—Ç–∞—Ä–∫–µ:</h3>
                            <div class="detail-item">
                                <span class="detail-label">–ò–º—è —Ñ–∞–π–ª–∞:</span>
                                <span class="detail-value">${escapeHtml(
                                  avatar.filename
                                )}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">–†–∞–∑–º–µ—Ä:</span>
                                <span class="detail-value">${
                                  avatar.size_formatted
                                }</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">–¢–∏–ø:</span>
                                <span class="detail-value">${avatar.type}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">–ó–∞–≥—Ä—É–∂–µ–Ω–∞:</span>
                                <span class="detail-value">${
                                  avatar.upload_date
                                }</span>
                            </div>
                        </div>
                    `;

            deleteBtn.disabled = false;
          } else {
            avatarPreview.innerHTML = `
                        <div class="avatar-placeholder">
                            <span>–ê–≤–∞—Ç–∞—Ä–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞</span>
                        </div>
                    `;

            avatarInfo.innerHTML = `
                        <div class="avatar-details">
                            <h3>–ê–≤–∞—Ç–∞—Ä–∫–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</h3>
                            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É</p>
                        </div>
                    `;

            deleteBtn.disabled = true;
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞:", error);
          document.getElementById("avatarInfo").innerHTML =
            '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤–∞—Ç–∞—Ä–∫–µ</div>';
        }
      }

      async function uploadAvatar() {
        const fileInput = document.getElementById("avatarInput");
        const uploadBtn = document.getElementById("uploadBtn");

        if (!fileInput.files[0]) {
          showMessage("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª", "error");
          return;
        }

        const formData = new FormData();
        formData.append("avatar", fileInput.files[0]);

        uploadBtn.disabled = true;
        uploadBtn.textContent = "üì§ –ó–∞–≥—Ä—É–∑–∫–∞...";

        try {
          const response = await fetch("/api/avatar", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (result.success) {
            showMessage("–ê–≤–∞—Ç–∞—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!", "success");
            fileInput.value = "";
            document.getElementById("avatarFileName").textContent =
              "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
            await loadAvatar();
          } else {
            showMessage(
              result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏",
              "error"
            );
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞:", error);
          showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏", "error");
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.textContent = "üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É";
        }
      }

      async function deleteAvatar() {
        if (!currentAvatar) return;

        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É?")) return;

        try {
          const response = await fetch("/api/avatar", {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showMessage("–ê–≤–∞—Ç–∞—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∞", "success");
            currentAvatar = null;
            await loadAvatar();
          } else {
            showMessage(
              result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏",
              "error"
            );
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞:", error);
          showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏", "error");
        }
      }

      document
        .getElementById("avatarInput")
        .addEventListener("change", function (e) {
          const fileName = this.files[0]
            ? this.files[0].name
            : "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
          document.getElementById("avatarFileName").textContent = fileName;

          if (this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const preview = document.getElementById("avatarPreview");
              preview.innerHTML = `<img src="${e.target.result}" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="avatar-image">`;
            };
            reader.readAsDataURL(this.files[0]);
          }
        });

      function showMessage(text, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        messageDiv.classList.remove("hidden");

        setTimeout(() => {
          messageDiv.classList.add("hidden");
        }, 3000);
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      document.addEventListener("DOMContentLoaded", loadAvatar);
    </script>
  </body>
</html>
