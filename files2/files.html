<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìã –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤</h1>
        <a href="/" class="back-button">‚¨Ö –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <a href="/avatar" class="link-button avatar-link"
          >üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∫–æ–π</a
        >
      </div>

      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:</span>
          <span class="stat-value" id="totalFiles">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä:</span>
          <span class="stat-value" id="totalSize">0 –ë</span>
        </div>
      </div>

      <div class="files-list" id="filesList">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤...</div>
      </div>
    </div>

    <script>
      async function loadFiles() {
        try {
          const response = await fetch("/api/files");
          const files = await response.json();

          const filesList = document.getElementById("filesList");
          const totalFiles = document.getElementById("totalFiles");
          const totalSize = document.getElementById("totalSize");

          if (files.error) {
            filesList.innerHTML = `<div class="error">${files.error}</div>`;
            return;
          }

          totalFiles.textContent = files.length;

          const totalBytes = files.reduce(
            (sum, file) => sum + (file.size || 0),
            0
          );
          totalSize.textContent = formatSize(totalBytes);

          if (files.length === 0) {
            filesList.innerHTML =
              '<div class="empty">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</div>';
            return;
          }

          let html = "";
          files.forEach((file) => {
            html += `
                        <div class="file-item" data-id="${file.id}">
                            <div class="file-info">
                                <div class="file-name">${escapeHtml(
                                  file.name
                                )}</div>
                                <div class="file-details">
                                    <span class="file-size">${
                                      file.size_formatted ||
                                      formatSize(file.size)
                                    }</span>
                                    <span class="file-date">${
                                      file.upload_date
                                    }</span>
                                    <span class="file-type">${
                                      file.type || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
                                    }</span>
                                </div>
                            </div>
                            <div class="file-actions">
                                <a href="/download/${
                                  file.id
                                }" class="action-button download">
                                    üì• –°–∫–∞—á–∞—Ç—å
                                </a>
                                <button onclick="deleteFile(${
                                  file.id
                                })" class="action-button delete">
                                    üóë –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
          });

          filesList.innerHTML = html;
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞:", error);
          document.getElementById("filesList").innerHTML =
            '<div class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤</div>';
        }
      }

      async function deleteFile(id) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∞–π–ª?")) return;

        try {
          const response = await fetch(`/api/files/${id}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            document.querySelector(`.file-item[data-id="${id}"]`).remove();

            const totalFiles = document.getElementById("totalFiles");
            totalFiles.textContent = parseInt(totalFiles.textContent) - 1;

            showMessage("–§–∞–π–ª —É–¥–∞–ª–µ–Ω", "success");
          } else {
            showMessage(result.error || "–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏", "error");
          }
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞:", error);
          showMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞", "error");
        }
      }

      function formatSize(bytes) {
        if (!bytes) return "0 –ë";
        const k = 1024;
        const sizes = ["–ë", "–ö–ë", "–ú–ë", "–ì–ë"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function showMessage(text, type) {
        const message = document.createElement("div");
        message.className = `message ${type}`;
        message.textContent = text;
        message.style.position = "fixed";
        message.style.top = "20px";
        message.style.right = "20px";
        message.style.padding = "10px 20px";
        message.style.borderRadius = "5px";
        message.style.zIndex = "1000";

        document.body.appendChild(message);

        setTimeout(() => {
          message.remove();
        }, 3000);
      }

      document.addEventListener("DOMContentLoaded", loadFiles);

      setInterval(loadFiles, 30000);
    </script>
  </body>
</html>
